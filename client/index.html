<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css"
        integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <title>Document</title>
</head>

<body>
    <div class="container body-content">
        <div class="row">
            <div class="col-12justify-content-center">
                <h1 class="justify-content-center display-2">Client</h1>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-sm">
                <form id="formRegister">
                    <div class="">
                        <h1>Registrar</h1>
                    </div>
                    <div class=" justify-content-start" style="padding-top:10px;">
                        <label>NOME:</label>
                    </div>
                    <div class="justify-content-center" style="padding-top:10px;">
                        <input class="form-control" autofocus name="username" required></input>
                    </div>
                    <div class=" justify-content-start" style="padding-top:10px;">
                        <label>EMAIL:</label>
                    </div>
                    <div class="justify-content-center" style="padding-top:10px;">
                        <input class="form-control" name="email" required></input>
                    </div>
                    <div class=" justify-content-start" style="padding-top:10px;">
                        <label>SENHA:</label>
                    </div>
                    <div class="justify-content-center" style="padding-top:10px;">
                        <input class="form-control" type="password" name="password" required></input>
                    </div>
                    <div class="justify-content-end" style="padding-top:10px;">
                        <button class="btn btn-primary">REGISTRAR</button>
                    </div>
                </form>
            </div>
            <div class="col-sm">
                <div class="">
                    <h1>Login</h1>
                </div>
                <form id="formLogin">
                    <div class="justify-content-start" style="padding-top:10px;">
                        <label>EMAIL:</label>
                    </div>
                    <div class="justify-content-center" style="padding-top:10px;">
                        <input class="form-control" name="email" required></input>
                    </div>
                    <div class=" justify-content-start" style="padding-top:10px;">
                        <label>SENHA:</label>
                    </div>
                    <div class="justify-content-center" style="padding-top:10px;">
                        <input class="form-control" type="password" name="password" required></input>
                    </div>
                    <div class="justify-content-end" style="padding-top:10px;">
                        <button class="btn btn-primary">ENTRAR</button>
                    </div>
                </form>
            </div>
        </div>
        <hr>
        <div class="row">
            <div class="col-12">
                <button id="btnMostrarUsuarioAuth" class="btn btn-primary">
                    Mostrar Usu√°rio Autenticado
                </button>

                <button id="btnLogout" class="btn btn-primary">
                    Logout
                </button>
            </div>
        </div>
        <hr>
        <div class="row">
            <h3 class="col-12" id="mostrar-usuario">
            </h3>
        </div>
    </div>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script>
        const formRegister = document.getElementById('formRegister');
        const formLogin = document.getElementById('formLogin');

        const baseUrl = 'http://127.0.0.1:3004';

        /**
         * 
         * 
         *         REGISTRO
         * 
         * 
         * */
        formRegister.onsubmit = () => {

            var form = new FormData(formRegister);

            axios(baseUrl + "/register", {
                method: "POST",
                data: form,
                withCredentials: true
            }).then(response => {
                if (response.status == 200) {
                    window.localStorage.setItem('user', JSON.stringify(response));
                } else {
                    throw new Error('Ops! Houve um erro em nosso servidor.');
                }
            }).catch(error => {
                console.log(error);
                log(JSON.stringify(error));
            });

            return false;
        }
        /**
         * 
         * 
         *          LOGIN
         * 
         * 
         * */
        formLogin.onsubmit = (ev) => {
            ev.preventDefault();

            var form = new FormData(formLogin);

            axios(baseUrl + "/login", {
                method: "POST",
                data: form,
                withCredentials: true
            }).then(response => {
                if (response.status == 200) {
                    window.localStorage.setItem('user', JSON.stringify(response.data));
                } else {
                    throw new Error('Ops! Houve um erro em nosso servidor.');
                }
            }).catch(error => {
                console.log(error);
                log(JSON.stringify(error));
            });

            return false;
        }

        document.getElementById('btnMostrarUsuarioAuth').onclick = () => {

            if (window.localStorage.getItem('user')) {
                const { id } = JSON.parse(window.localStorage.getItem('user'));
                axios(baseUrl + "/users/" + id, {
                    method: "GET",
                    withCredentials: true
                }).then(response => {
                    return response.status == 200 ? log(JSON.stringify(response.data)): response.statusText;
                }).catch(error => {
                    console.log(error);
                    log(JSON.stringify(error));
                });
            }

        }

        document.getElementById('btnLogout').onclick = () => {

            if (window.localStorage.getItem('user')) {
                window.localStorage.removeItem('user');
                axios(baseUrl + '/logout', {
                    method: "GET",
                    withCredentials: true
                }).then(response => {
                    return response.status === 200 ? log(JSON.stringify(response.data)) : response.statusText;
                }).catch(response => {
                    log(JSON.stringify(response));
                })
            }

        }

        function log(content) {
            document.getElementById('mostrar-usuario').append(content);
        }
    </script>
</body>

</html>